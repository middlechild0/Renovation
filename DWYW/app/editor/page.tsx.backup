/**
 * Main Editor Page
 * 
 * Full design workspace with customization panel, live preview, and AI assistant
 */

'use client';

import { useState, useEffect } from 'react';
import { useProjectStore } from '@/store/project';
import { templateRegistry } from '@/lib/templates';
import { TemplateSelector } from '@/components/TemplateSelector';
import { CustomizationPanel } from '@/components/CustomizationPanel';
import { LivePreview } from '@/components/LivePreview';
import { AIAssistant } from '@/components/AIAssistant';
import { PricingDisplay } from '@/components/PricingDisplay';
import { UserProject, DesignCustomization, FeatureId, TemplateDefinition } from '@/types';
import { motion } from 'framer-motion';

export default function EditorPage() {
  const { currentProject, setProject, setPreviewMode, previewMode } = useProjectStore();
  const [showTemplateSelector, setShowTemplateSelector] = useState(!currentProject);
  const [showAIAssistant, setShowAIAssistant] = useState(false);
  const [showCustomization, setShowCustomization] = useState(true);

  const handleTemplateSelect = (template: TemplateDefinition) => {
    // Create a new project
    const defaultDesign: DesignCustomization = {
      colors: {
        primary: '#3B82F6',
        secondary: '#10B981',
        accent: '#F59E0B',
        background: '#FFFFFF',
        text: '#1F2937',
        textSecondary: '#6B7280',
      },
      fonts: {
        primary: 'Inter',
        secondary: 'Roboto',
        heading: 'Poppins',
      },
      spacing: 1,
      borderRadius: 8,
      animations: {
        enabled: true,
        style: 'fade',
        parallax: false,
        hover: true,
      },
    };

    const project: UserProject = {
      id: Date.now().toString(),
      userId: 'demo-user',
      template,
      customization: defaultDesign,
      selectedFeatures: [] as FeatureId[],
      content: {},
      createdAt: new Date(),
      updatedAt: new Date(),
      pricing: {
        total: template.basePrice,
        breakdown: [],
      },
      aiAnalysis: null,
      guardrails: [],
    };

    setProject(project);
    setShowTemplateSelector(false);
  };

  if (showTemplateSelector) {
    return <TemplateSelector onSelect={handleTemplateSelect} />;
  }

  return (
    <div className="h-screen flex flex-col bg-gray-50">
      {/* Top Bar */}
      <div className="h-16 bg-white border-b border-gray-200 flex items-center justify-between px-6">
        <div className="flex items-center space-x-4">
          <h1 className="text-2xl font-bold">
            Design What You Want
          </h1>
          {currentProject && (
            <span className="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm font-medium">
              {currentProject.template.name}
            </span>
          )}
        </div>

        <div className="flex items-center space-x-4">
          {/* Preview Mode Selector */}
          <div className="flex bg-gray-100 rounded-lg p-1">
            <button
              onClick={() => setPreviewMode('desktop')}
              className={`px-3 py-1 rounded transition-colors ${
                previewMode === 'desktop'
                  ? 'bg-white shadow-sm'
                  : 'hover:bg-gray-200'
              }`}
            >
              üñ•Ô∏è Desktop
            </button>
            <button
              onClick={() => setPreviewMode('tablet')}
              className={`px-3 py-1 rounded transition-colors ${
                previewMode === 'tablet'
                  ? 'bg-white shadow-sm'
                  : 'hover:bg-gray-200'
              }`}
            >
              üì± Tablet
            </button>
            <button
              onClick={() => setPreviewMode('mobile')}
              className={`px-3 py-1 rounded transition-colors ${
                previewMode === 'mobile'
                  ? 'bg-white shadow-sm'
                  : 'hover:bg-gray-200'
              }`}
            >
              üì± Mobile
            </button>
          </div>

          {/* Action Buttons */}
          <button
            onClick={() => setShowCustomization(!showCustomization)}
            className="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg font-medium transition-colors"
          >
            {showCustomization ? 'Hide' : 'Show'} Customization
          </button>

          <button
            onClick={() => setShowAIAssistant(!showAIAssistant)}
            className="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-medium transition-colors"
          >
            ‚ú® AI Assistant
          </button>

          <button
            onClick={() => setShowTemplateSelector(true)}
            className="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors"
          >
            Change Template
          </button>

          <button className="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium transition-colors">
            Deploy ‚Üí
          </button>
        </div>
      </div>

      {/* Main Content */}
      <div className="flex-1 flex overflow-hidden">
        {/* Left: Customization Panel */}
        {showCustomization && (
          <motion.div
            initial={{ width: 0 }}
            animate={{ width: 320 }}
            exit={{ width: 0 }}
            className="flex-shrink-0 overflow-hidden"
          >
            <CustomizationPanel />
          </motion.div>
        )}

        {/* Center: Live Preview */}
        <div className="flex-1 overflow-hidden">
          <LivePreview />
        </div>

        {/* Right: AI Assistant */}
        {showAIAssistant && (
          <motion.div
            initial={{ width: 0 }}
            animate={{ width: 380 }}
            exit={{ width: 0 }}
            className="flex-shrink-0 overflow-hidden"
          >
            <AIAssistant />
          </motion.div>
        )}
      </div>

      {/* Pricing Display */}
      <PricingDisplay />
    </div>
  );
}
